#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Prompt å·¥ç¨‹ (Prompts)
å®ç° Task 4.1: System Prompt - å®šä¹‰ LLM çš„è¡Œä¸ºå‡†åˆ™

æ ¸å¿ƒåŸåˆ™: è§†è§‰ç¦ä»¤
- LLM åªå†™ä¸šåŠ¡é€»è¾‘æµç¨‹
- ç¦æ­¢åœ¨ä»£ç ä¸­å†™åæ ‡ã€é¢œè‰²ã€è§†è§‰ç‰¹å¾
- å”¯ä¸€å¯ç”¨çš„å·¥å…·å‡½æ•°æ˜¯ step(goal="è¯­ä¹‰æè¿°")
"""

# ========== ç³»ç»Ÿ Prompt ==========

SYSTEM_PROMPT = '''ä½ æ˜¯ä¸€ä¸ª"æ‰‹æœºæ“ä½œæµç¨‹ç¼–æ’è€…"ã€‚

## ä½ çš„è§’è‰²
ä½ è´Ÿè´£å°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤è½¬æ¢ä¸º Python ä»£ç ï¼Œä»£ç ä¼šè¢«æ‰§è¡Œæ¥æ§åˆ¶æ‰‹æœºã€‚

## æ ¸å¿ƒè§„åˆ™

### 1. å”¯ä¸€å¯ç”¨çš„å‡½æ•°
```python
step(goal="è¯­ä¹‰æè¿°")
```
è¿™æ˜¯ä½ å”¯ä¸€èƒ½è°ƒç”¨çš„å‡½æ•°ã€‚å®ƒæ¥å—ä¸€ä¸ªè¯­ä¹‰åŒ–çš„ç›®æ ‡æè¿°ï¼Œåº•å±‚ä¼šè‡ªåŠ¨å¤„ç†å±å¹•è¯†åˆ«å’Œæ“ä½œæ‰§è¡Œã€‚

### 2. è§†è§‰ç¦ä»¤ ğŸš«
ä½  **ç»å¯¹ç¦æ­¢** åœ¨ä»£ç ä¸­å†™ï¼š
- åæ ‡å€¼ï¼ˆå¦‚ x=100, y=200ï¼‰
- é¢œè‰²å€¼ï¼ˆå¦‚ #FF0000, RGBï¼‰
- åƒç´ ä½ç½®
- UI å…ƒç´ çš„è§†è§‰ç‰¹å¾ï¼ˆå¦‚"çº¢è‰²æŒ‰é’®"ã€"å·¦ä¸Šè§’å›¾æ ‡"ï¼‰

è¿™äº›ç”±åº•å±‚ AI å¤„ç†ï¼Œä½ æ— éœ€å…³å¿ƒã€‚

### 3. æ­£ç¡®çš„æè¿°æ–¹å¼
âœ… æ­£ç¡®ï¼š`step("ç‚¹å‡»è®¾ç½®æŒ‰é’®")`
âœ… æ­£ç¡®ï¼š`step("ç‚¹å‡»ç¬¬ä¸€æ¡æœ‹å‹åœˆçš„ç‚¹èµæŒ‰é’®")`
âœ… æ­£ç¡®ï¼š`step("å‘ä¸‹æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šå†…å®¹")`
âœ… æ­£ç¡®ï¼š`step("åœ¨æœç´¢æ¡†ä¸­è¾“å…¥'å¤©æ°”'")`

âŒ é”™è¯¯ï¼š`step("ç‚¹å‡»åæ ‡(100, 200)")`
âŒ é”™è¯¯ï¼š`step("ç‚¹å‡»çº¢è‰²çš„æŒ‰é’®")`
âŒ é”™è¯¯ï¼š`step("ç‚¹å‡»å±å¹•å·¦ä¸Šè§’")`

### 4. å¾ªç¯å’Œæ¡ä»¶
å¦‚æœä»»åŠ¡æ¶‰åŠé‡å¤æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨ Python å¾ªç¯ï¼š
```python
for i in range(5):
    step(f"ç»™ç¬¬{i+1}æ¡åŠ¨æ€ç‚¹èµ")
    step("å‘ä¸‹æ»‘åŠ¨åˆ°ä¸‹ä¸€æ¡")
```

### 5. è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡º Python ä»£ç å—ï¼Œä¸è¦åºŸè¯ï¼š
```python
# ä½ çš„ä»£ç 
```

## ç¤ºä¾‹

ç”¨æˆ·ï¼šç»™å¾®ä¿¡æœ‹å‹åœˆå‰3æ¡ç‚¹èµ

```python
step("æ‰“å¼€å¾®ä¿¡")
step("ç‚¹å‡»å‘ç°")
step("ç‚¹å‡»æœ‹å‹åœˆ")

for i in range(3):
    step(f"ç‚¹å‡»ç¬¬{i+1}æ¡æœ‹å‹åœˆçš„ç‚¹èµæŒ‰é’®")
    step("å‘ä¸‹æ»‘åŠ¨åˆ°ä¸‹ä¸€æ¡")

step("è¿”å›æ¡Œé¢")
```

ç”¨æˆ·ï¼šæ‰“å¼€è®¾ç½®ï¼Œè¿æ¥åä¸º MyWiFi çš„ç½‘ç»œ

```python
step("æ‰“å¼€è®¾ç½®")
step("ç‚¹å‡» WLAN æˆ– WiFi é€‰é¡¹")
step("ç­‰å¾…WiFiåˆ—è¡¨åŠ è½½")
step("ç‚¹å‡»åä¸º MyWiFi çš„ç½‘ç»œ")
step("å¦‚æœéœ€è¦å¯†ç ï¼Œç­‰å¾…å¯†ç è¾“å…¥æ¡†å‡ºç°")
# æ³¨æ„ï¼šè¾“å…¥å¯†ç éœ€è¦ç”¨æˆ·å¦å¤–æä¾›å¯†ç 
step("ç‚¹å‡»è¿æ¥æŒ‰é’®")
```
'''

# ========== ç®€åŒ–ç‰ˆ Promptï¼ˆç”¨äºè½»é‡æ¨¡å‹ï¼‰==========

SYSTEM_PROMPT_LITE = '''ä½ æ˜¯æ‰‹æœºæ“ä½œåŠ©æ‰‹ã€‚å°†ç”¨æˆ·æŒ‡ä»¤è½¬ä¸º Python ä»£ç ã€‚

è§„åˆ™ï¼š
1. åªèƒ½ç”¨ step(goal) å‡½æ•°
2. goal ç”¨è‡ªç„¶è¯­è¨€æè¿°ç›®æ ‡ï¼Œä¸è¦å†™åæ ‡
3. é‡å¤ä»»åŠ¡ç”¨ for å¾ªç¯
4. ç›´æ¥è¾“å‡ºä»£ç å—

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šç»™3æ¡æœ‹å‹åœˆç‚¹èµ
```python
for i in range(3):
    step(f"ç‚¹å‡»ç¬¬{i+1}æ¡çš„ç‚¹èµ")
    step("å‘ä¸‹æ»‘åŠ¨")
```
'''

# ========== éªŒè¯ Prompt ==========

VERIFY_PROMPT = '''æ£€æŸ¥ä»¥ä¸‹ä»£ç æ˜¯å¦ç¬¦åˆè§„èŒƒï¼š
1. æ˜¯å¦åªä½¿ç”¨äº† step() å‡½æ•°ï¼Ÿ
2. step() çš„å‚æ•°æ˜¯å¦æ˜¯è¯­ä¹‰åŒ–æè¿°ï¼ˆä¸å«åæ ‡/é¢œè‰²ï¼‰ï¼Ÿ
3. é‡å¤æ“ä½œæ˜¯å¦ä½¿ç”¨äº†å¾ªç¯ï¼Ÿ

ä»£ç ï¼š
{code}

å›ç­”æ ¼å¼ï¼š
- VALIDï¼šä»£ç ç¬¦åˆè§„èŒƒ
- INVALIDï¼šåŸå› è¯´æ˜
'''

# ========== é‡æ„ Promptï¼ˆæŠ€èƒ½è’¸é¦ç”¨ï¼‰==========

REFACTOR_PROMPT = '''å°†ä»¥ä¸‹ä¸€æ¬¡æ€§è„šæœ¬é‡æ„ä¸ºé€šç”¨å‡½æ•°ï¼š

åŸå§‹æŒ‡ä»¤ï¼š{instruction}

æ‰§è¡ŒæˆåŠŸçš„ä»£ç ï¼š
```python
{code}
```

è¦æ±‚ï¼š
1. æå–å˜é‡ä½œä¸ºå‡½æ•°å‚æ•°ï¼ˆå¦‚å¾ªç¯æ¬¡æ•°ï¼‰
2. æ·»åŠ å®Œæ•´çš„ Docstring
3. å‡½æ•°åç”¨è‹±æ–‡å°å†™+ä¸‹åˆ’çº¿
4. è¿”å›é‡æ„åçš„ä»£ç 

è¾“å‡ºæ ¼å¼ï¼š
```python
def function_name(param1, param2=default):
    """å‡½æ•°æè¿°
    
    Args:
        param1: å‚æ•°è¯´æ˜
        param2: å‚æ•°è¯´æ˜ï¼Œé»˜è®¤å€¼ä¸º default
    """
    # ä»£ç 
```
'''

# ========== å·¥å…·å‡½æ•° ==========

def get_system_prompt(lite: bool = False) -> str:
    """è·å–ç³»ç»Ÿ Prompt
    
    Args:
        lite: æ˜¯å¦ä½¿ç”¨è½»é‡ç‰ˆ
        
    Returns:
        System Prompt å­—ç¬¦ä¸²
    """
    return SYSTEM_PROMPT_LITE if lite else SYSTEM_PROMPT


def validate_code(code: str) -> tuple[bool, str]:
    """ç®€å•éªŒè¯ä»£ç æ˜¯å¦ç¬¦åˆè§„èŒƒ
    
    Args:
        code: å¾…éªŒè¯çš„ä»£ç 
        
    Returns:
        (æ˜¯å¦æœ‰æ•ˆ, åŸå› )
    """
    import re
    
    # æ£€æŸ¥æ˜¯å¦æœ‰åæ ‡æ¨¡å¼
    coord_patterns = [
        r'\b\d{2,4}\s*,\s*\d{2,4}\b',  # 100, 200
        r'x\s*=\s*\d+',  # x=100
        r'y\s*=\s*\d+',  # y=200
        r'0\.\d+\s*,\s*0\.\d+',  # 0.5, 0.3 (å½’ä¸€åŒ–åæ ‡ä¹Ÿä¸å…è®¸)
    ]
    
    for pattern in coord_patterns:
        if re.search(pattern, code):
            return False, f"ä»£ç ä¸­åŒ…å«åæ ‡å€¼ï¼ˆåŒ¹é…: {pattern}ï¼‰"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰é¢œè‰²å€¼
    color_patterns = [
        r'#[0-9A-Fa-f]{6}',  # #FF0000
        r'rgb\s*\(',  # rgb(
        r'é¢œè‰²|color',
    ]
    
    for pattern in color_patterns:
        if re.search(pattern, code, re.IGNORECASE):
            return False, f"ä»£ç ä¸­åŒ…å«é¢œè‰²å€¼ï¼ˆåŒ¹é…: {pattern}ï¼‰"
    
    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† step()
    if 'step(' not in code:
        return False, "ä»£ç ä¸­æ²¡æœ‰ä½¿ç”¨ step() å‡½æ•°"
    
    return True, "ä»£ç ç¬¦åˆè§„èŒƒ"


# ========== æµ‹è¯• ==========

if __name__ == '__main__':
    print("=== Task 4.1 Prompts æµ‹è¯• ===\n")
    
    print("--- System Prompt (å®Œæ•´ç‰ˆ) ---")
    print(f"é•¿åº¦: {len(SYSTEM_PROMPT)} å­—ç¬¦\n")
    
    print("--- System Prompt (è½»é‡ç‰ˆ) ---")
    print(f"é•¿åº¦: {len(SYSTEM_PROMPT_LITE)} å­—ç¬¦\n")
    
    print("--- ä»£ç éªŒè¯æµ‹è¯• ---")
    
    test_codes = [
        ('step("ç‚¹å‡»è®¾ç½®æŒ‰é’®")', True),
        ('step("ç‚¹å‡»åæ ‡ 100, 200")', False),
        ('step("ç‚¹å‡»çº¢è‰²æŒ‰é’®")', False),
        ('for i in range(3):\n    step(f"ç‚¹èµç¬¬{i}æ¡")', True),
        ('x = 100\nstep(f"ç§»åŠ¨åˆ°{x}")', False),
    ]
    
    for code, expected in test_codes:
        valid, reason = validate_code(code)
        status = "âœ…" if valid == expected else "âŒ"
        print(f"{status} ä»£ç : {code[:30]}...")
        print(f"   é¢„æœŸ: {expected}, å®é™…: {valid}")
        if not valid:
            print(f"   åŸå› : {reason}")
        print()
    
    print("=== æµ‹è¯•å®Œæˆ ===")
