# Semantic Agent - ä¸‰å±‚æ¶æ„æ‰‹æœºæ§åˆ¶ç³»ç»Ÿ

åŸºäº**ä¸‰å±‚æ¶æ„**çš„ç‰©ç†Agentç³»ç»Ÿï¼Œå®ç° L1 ç­–ç•¥å±‚ (LLM) + L2 è¿è¡Œæ—¶ (Runtime) + L3 æˆ˜æœ¯å±‚ (AutoGLM) çš„ç²¾ç¡®åˆ†å·¥ã€‚

> ğŸ‰ **v2.0 å‘å¸ƒ** - å®Œæˆæ¶æ„é‡æ„ï¼ŒAutoGLM æ­£ç¡®å®šä½ä¸ºæ‰§è¡Œå±‚ï¼ˆå°è„‘ï¼‰ï¼

## ğŸ¯ æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1 ç­–ç•¥å±‚ (Strategy Layer)                                      â”‚
â”‚  - æ¨¡å‹: GPT-4 / Claude / glm-4-flash                           â”‚
â”‚  - èŒè´£: é•¿ç¨‹è§„åˆ’ã€é€»è¾‘ç¼–æ’ã€çŠ¶æ€ç®¡ç†                            â”‚
â”‚  - è¾“å‡º: Python è„šæœ¬ (ç”¨ for/while è°ƒç”¨ step())                  â”‚
â”‚  - ç¦æ­¢: è¾“å‡ºä»»ä½•åæ ‡                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Python ä»£ç 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2 è¿è¡Œæ—¶ (Runtime Layer)                                       â”‚
â”‚  - ç»„ä»¶: TaskRuntime                                            â”‚
â”‚  - èŒè´£: æ²™ç›’æ‰§è¡Œã€æä¾› step() æ¥å£ã€å¼‚å¸¸å¤„ç†                    â”‚
â”‚  - æ¥å£: step(goal: str) -> bool                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ step("ç‚¹å‡»æœç´¢æ¡†")
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3 æˆ˜æœ¯å±‚ (Tactical Layer)                                      â”‚
â”‚  - æ¨¡å‹: AutoGLM (autoglm-phone)                                â”‚
â”‚  - èŒè´£: Grounding (è§†è§‰å®šä½) + å¾®è§‚éªŒè¯                         â”‚
â”‚  - æµç¨‹: æˆªå›¾ â†’ å®šä½åæ ‡ â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ é‡è¯•                   â”‚
â”‚  - è¾“å‡º: Tap(0.23, 0.67) ç­‰ç²¾ç¡®åæ ‡                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ æœºæ¢°è‡‚æŒ‡ä»¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é©±åŠ¨å±‚ (Driver Layer)                                           â”‚
â”‚  - Serial / WiFi / Mock                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. åæ ‡æ§åˆ¶æƒç§»äº¤
- âŒ **æ—§**: LLM åˆ†ææˆªå›¾ â†’ LLM è¾“å‡ºåæ ‡ â†’ æ‰§è¡Œ
- âœ… **æ–°**: LLM ç¦æ­¢æ¥è§¦åæ ‡ â†’ LLM è¾“å‡ºè¯­ä¹‰ â†’ AutoGLM è¾“å‡ºåæ ‡ â†’ æ‰§è¡Œ

### 2. å¾®è§‚éªŒè¯æƒç§»äº¤
- âŒ **æ—§**: æˆªå›¾å›ä¼ ç­–ç•¥å±‚ LLM éªŒè¯
- âœ… **æ–°**: AutoGLM å†…éƒ¨è‡ªé—­ç¯éªŒè¯

### 3. é€»è¾‘å®¹å™¨å¼•å…¥
- âŒ **æ—§**: çº¿æ€§å¯¹è¯ï¼Œç”¨æˆ·è¯´ä¸€å¥åšä¸€æ­¥
- âœ… **æ–°**: ä»£ç å³è¡ŒåŠ¨ï¼ŒLLM ç”Ÿæˆè„šæœ¬ï¼ŒPython æ§åˆ¶å¾ªç¯

## ğŸ“ é¡¹ç›®ç»“æ„

```
semantic-agent/
â”œâ”€â”€ brain/                    # L1 ç­–ç•¥å±‚ âœ…
â”‚   â””â”€â”€ strategy_prompt.py   # ç­–ç•¥å±‚ Prompt (è§†è§‰ç¦ä»¤)
â”œâ”€â”€ runtime/                  # L2 è¿è¡Œæ—¶ âœ…
â”‚   â””â”€â”€ task_runtime_v2.py   # æ²™ç›’æ‰§è¡Œç¯å¢ƒ (åªæ³¨å…¥ step)
â”œâ”€â”€ tactical/                 # L3 æˆ˜æœ¯å±‚ âœ…
â”‚   â””â”€â”€ autoglm_driver.py    # AutoGLM é©±åŠ¨ (å¾®è§‚é—­ç¯)
â”œâ”€â”€ drivers/                  # ç¡¬ä»¶é©±åŠ¨å±‚ âœ…
â”‚   â”œâ”€â”€ base_driver.py       # æŠ½è±¡åŸºç±» + @safe_guard
â”‚   â”œâ”€â”€ serial_driver.py     # ä¸²å£é©±åŠ¨ (GRBL)
â”‚   â”œâ”€â”€ wifi_driver.py       # WiFié©±åŠ¨ (ESP32-S3)
â”‚   â””â”€â”€ mock_driver.py       # Mocké©±åŠ¨ (æµ‹è¯•)
â”œâ”€â”€ tests/                    # æµ‹è¯• âœ…
â”‚   â””â”€â”€ test_three_layers.py # ä¸‰å±‚æ¶æ„æµ‹è¯•
â”œâ”€â”€ docs/                     # æ–‡æ¡£
â”‚   â””â”€â”€ THREE_LAYER_ARCHITECTURE.md
â”œâ”€â”€ main_v3.py                # ä¸»å…¥å£ (ä¸‰å±‚é›†æˆ)
â”œâ”€â”€ quick_start.sh            # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â””â”€â”€ requirements.txt
```

## âš™ï¸ å®‰è£…

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
export ZHIPUAI_API_KEY='your_actual_key'
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è¿è¡Œæµ‹è¯•

```bash
python3 tests/test_three_layers.py
```

é¢„æœŸè¾“å‡ºï¼š
```
============================================================
ğŸ§ª å¼€å§‹æµ‹è¯•ä¸‰å±‚æ¶æ„
============================================================
âœ… Phase 1 æµ‹è¯•é€šè¿‡
âœ… Phase 2 æµ‹è¯•é€šè¿‡
âœ… Phase 3 æµ‹è¯•é€šè¿‡
âœ… Phase 4 æµ‹è¯•é€šè¿‡
============================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!
============================================================
```

### 2. äº¤äº’æ¨¡å¼

```bash
python3 main_v3.py
```

```
ğŸ¯ ä»»åŠ¡: ç»™å‰ 10 æ¡è§†é¢‘ç‚¹èµ

[LLM] ğŸ“ Plan - ç”Ÿæˆæ‰§è¡Œè„šæœ¬...
[LLM] âœ… ç”Ÿæˆçš„ä»£ç :
  1 | step('æ‰“å¼€çŸ­è§†é¢‘åº”ç”¨')
  2 | for i in range(10):
  3 |     step('ç‚¹èµå½“å‰è§†é¢‘')
  4 |     step('æ»‘åŠ¨åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘')

[Runtime] âš™ï¸  Execute - å¼€å§‹æ‰§è¡Œ...
[AutoGLMDriver] æ­¥éª¤ #1: æ‰“å¼€çŸ­è§†é¢‘åº”ç”¨
[AutoGLMDriver] ğŸ“¸ a. Capture - è·å–æˆªå›¾
[AutoGLMDriver] ğŸ§  b. Plan - è°ƒç”¨ AutoGLM åˆ†æ
...
```

### 3. API è°ƒç”¨ç¤ºä¾‹

```python
from main_v3 import SemanticAgent
from drivers.mock_driver import MockDriver

# 1. åˆå§‹åŒ–
driver = MockDriver()  # æˆ– SerialDriver / WiFiDriver
agent = SemanticAgent(
    zhipuai_api_key="your_key",
    driver=driver,
    strategy_model="glm-4-flash",    # L1 ç­–ç•¥å±‚
    tactical_model="autoglm-phone"   # L3 æˆ˜æœ¯å±‚
)

# 2. æ‰§è¡Œä»»åŠ¡
result = agent.execute_task("æ‰“å¼€å¾®ä¿¡ï¼Œç»™å¼ ä¸‰å‘æ¶ˆæ¯'æ™šä¸Šåƒé¥­'")

# 3. æŸ¥çœ‹ç»“æœ
print(f"æˆåŠŸ: {result['success']}")
print(f"æ­¥éª¤: {result['steps']}")
print(f"ç”Ÿæˆçš„ä»£ç :\n{result['code']}")
```

## ğŸ¬ å·¥ä½œæµç¨‹ç¤ºä¾‹

### ç”¨æˆ·: "æ¸…ç©ºè´­ç‰©è½¦"

#### Step 1: L1 ç­–ç•¥å±‚ç”Ÿæˆä»£ç 
```python
# LLM (glm-4-flash) è¾“å‡º:
step('æ‰“å¼€è´­ç‰©è½¦')
step('ç‚¹å‡»ç¼–è¾‘')

while True:
    if not step('é€‰ä¸­ä¸€ä¸ªå•†å“'):
        break  # æ²¡å•†å“äº†
    step('ç‚¹å‡»åˆ é™¤')

step('å®Œæˆ')
```

#### Step 2: L2 è¿è¡Œæ—¶æ‰§è¡Œ
```python
# TaskRuntime é€è¡Œæ‰§è¡Œä»£ç 
# æ¯æ¬¡è°ƒç”¨ step() é€ä¼ ç»™ AutoGLMDriver
```

#### Step 3: L3 æˆ˜æœ¯å±‚å¤„ç†æ¯ä¸ª step()

ä»¥ `step('ç‚¹å‡»åˆ é™¤')` ä¸ºä¾‹:

1. **Capture**: æˆªå›¾å½“å‰ç•Œé¢
2. **Plan**: AutoGLM è¾“å‡º `Tap(0.85, 0.45)` - ç‚¹å‡»åˆ é™¤æŒ‰é’®
3. **Act**: æœºæ¢°è‡‚æ‰§è¡Œ Tap
4. **Verify**: å†æ¬¡æˆªå›¾ï¼ŒAutoGLM ç¡®è®¤"åˆ é™¤æˆåŠŸ"
5. **Return**: è¿”å› True

## âœ… å·²å®Œæˆ

| Phase | æ¨¡å— | æè¿° |
|-------|------|------|
| Phase 1 | `tactical/autoglm_driver.py` | AutoGLM é©±åŠ¨å°è£… (å¾®è§‚é—­ç¯) |
| Phase 2 | `runtime/task_runtime_v2.py` | TaskRuntime æ²™ç›’ (åªæ³¨å…¥ step) |
| Phase 3 | `brain/strategy_prompt.py` | ç­–ç•¥å±‚ Prompt (è§†è§‰ç¦ä»¤) |
| Phase 4 | `main_v3.py` | ä¸‰å±‚é›†æˆ + äº¤äº’ç•Œé¢ |

## ğŸ”œ è·¯çº¿å›¾

- [ ] å‘é‡æ•°æ®åº“æŠ€èƒ½æ£€ç´¢ (Chroma/Pinecone)
- [ ] å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡
- [ ] å¼‚å¸¸æ¢å¤ç­–ç•¥
- [ ] çœŸæœºç«¯åˆ°ç«¯æµ‹è¯•

## ğŸ“ æ ¸å¿ƒæ¦‚å¿µ

### AutoGLM å®šä½åˆ†æ

**AutoGLM (autoglm-phone) æ˜¯ä¸€ä¸ª VLA (Vision-Language-Action) æ¨¡å‹ï¼š**

| èƒ½åŠ› | è¯„ä»· |
|------|------|
| **Grounding (è§†è§‰å®šä½)** | âœ… å¼ºé¡¹ï¼ç»™å®ƒæˆªå›¾+"ç‚¹å‡»æœç´¢æ¡†"ï¼Œèƒ½ç²¾å‡†è¾“å‡º [x, y] |
| **UI äº¤äº’ç†è§£** | âœ… çŸ¥é“è¾“å…¥æ¡†è¦ç‚¹ã€æ»‘åŠ¨è¦æ‹–æ‹½ |
| **Long-horizon Planning** | âŒ å¼±é¡¹ï¼å¤æ‚ä»»åŠ¡å®¹æ˜“åœ¨ä¸­é—´è¿·å¤± |

**ç»“è®º**: AutoGLM ä¸é€‚åˆåšç­–ç•¥å±‚ï¼ˆå¤§è„‘ï¼‰ï¼Œé€‚åˆåšæ‰§è¡Œå±‚ï¼ˆå°è„‘/é«˜çº§é©±åŠ¨ï¼‰

### è§†è§‰ç¦ä»¤ (æ ¸å¿ƒè®¾è®¡åŸåˆ™)

**ç­–ç•¥å±‚ LLM ç”Ÿæˆçš„ä»£ç ç¦æ­¢åŒ…å«:**
- âŒ å±å¹•åæ ‡ `(x, y)`
- âŒ åƒç´ é¢œè‰² `#RRGGBB`
- âŒ å›¾åƒå¤„ç†é€»è¾‘

**åªå…è®¸è¯­ä¹‰æè¿°:**
```python
# âœ… æ­£ç¡®
step("ç‚¹å‡»å¾®ä¿¡å›¾æ ‡")
step("å‘ä¸‹æ»‘åŠ¨")

# âŒ é”™è¯¯
tap(0.5, 0.3)
click_at(100, 200)
```

è¿™æ ·ç­–ç•¥å±‚ç”Ÿæˆçš„ä»£ç å¯ä»¥è·¨è®¾å¤‡ã€è·¨åˆ†è¾¨ç‡å¤ç”¨ï¼

### å®‰å…¨å®ˆå«

æ‰€æœ‰ç‰©ç†åŠ¨ä½œéƒ½å— `@safe_guard` ä¿æŠ¤ï¼š

```python
@safe_guard
def tap(self, x: float, y: float):
    # è‡ªåŠ¨æ£€æŸ¥ 0.0 <= x <= 1.0
    # è‡ªåŠ¨æ£€æŸ¥ 0.0 <= y <= 1.0
    # è¶…å‡ºèŒƒå›´æŠ›å‡º SafetyError
    ...
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ PRï¼

## ğŸ“„ License

MIT
