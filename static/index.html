<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å‘è€…å·¥å…· - AutoGLM S3</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>ğŸ¤–</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --border: #1f2937;
            --primary: #22d3ee;
            --primary-dark: #0ea5e9;
            --text: #e5e7eb;
            --text-sub: #9ca3af;
            --danger: #f87171;
            --success: #34d399;
            --card-radius: 12px;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }
        a { color: var(--primary); text-decoration: none; }
        .layout {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 16px;
            padding: 16px;
            height: 100vh;
        }
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }
        .panel-title {
            font-weight: 600;
            font-size: 15px;
        }
        .section-title {
            font-size: 13px;
            color: var(--text-sub);
            margin: 12px 0 6px;
        }
        .field {
            margin-bottom: 10px;
        }
        .label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
            display: block;
        }
        input, select, button, textarea {
            font-family: inherit;
        }
        input, select, textarea {
            width: 100%;
            background: #0b1220;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
        }
        input:focus, select:focus, textarea:focus {
            outline: 1px solid var(--primary);
        }
        textarea { resize: vertical; min-height: 60px; }
        .btn {
            background: var(--primary);
            color: #0b1220;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s ease;
            font-size: 13px;
        }
        .btn.secondary {
            background: #1f2937;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.btn-success {
            background: #10b981;
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .btn.block { width: 100%; }
        .btn:hover { filter: brightness(1.05); }
        .flex { display: flex; gap: 8px; }
        .flex-col { display: flex; flex-direction: column; gap: 8px; }
        .split { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .log {
            flex: 1;
            background: #0b1220;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            color: var(--text-sub);
            overflow-y: auto;
        }
        .log-line { margin-bottom: 6px; }
        .log-line .time { color: #6b7280; margin-right: 6px; }
        .log-line.ok { color: var(--success); }
        .log-line.warn { color: #fbbf24; }
        .log-line.err { color: var(--danger); }
        .preview {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            background: #0b1220;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: crosshair;
            pointer-events: auto;
            user-select: none;
        }
        .preview img { 
            max-height: 90%;
            max-width: 90%;
            object-fit: contain;
            pointer-events: none; 
            display: block;
        }
        .preview .placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-sub);
            font-size: 13px;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .tool-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: #1f2937;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .tool-btn.active {
            background: #0ea5e9;
            color: #0b1220;
            border-color: #0ea5e9;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 999px; display: inline-block;
            background: var(--danger); margin-right: 6px;
        }
        .status-dot.ok { background: var(--success); }
        .badge {
            padding: 4px 8px;
            background: #1f2937;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-sub);
        }
        .badge.connected {
            background: rgba(34, 211, 238, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        .badge.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
            color: var(--danger);
            animation: pulse-error 2s infinite;
        }
        @keyframes pulse-error {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .row-between { display: flex; align-items: center; justify-content: space-between; }
        .small { font-size: 12px; color: var(--text-sub); }
        .scroll { overflow-y: auto; }
        
        /* ç‚¹å‡»åé¦ˆåŠ¨ç”» */
        @keyframes ripple {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        /* é¢„è§ˆåŒºåŸŸé¼ æ ‡æ ·å¼ */
        .preview {
            cursor: crosshair;
        }
        .preview.tool-swipe {
            cursor: move;
        }
        .preview.tool-long_press {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- å·¦ä¾§ï¼šè®¾å¤‡ä¸å‚æ•° -->
        <div class="panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">è®¾å¤‡è¿æ¥</div>
                <div class="badge" id="apiStatus"><span class="status-dot"></span>API</div>
            </div>

            <div class="section-title">1. è®¾å¤‡é€‰æ‹©</div>
            <div class="field">
                <label class="label">IP åœ°å€</label>
                <div class="flex">
                    <input id="manualIP" placeholder="192.168.x.x" value="">
                    <button class="btn" style="min-width:90px" onclick="connectManual()">æ‰‹åŠ¨è¿æ¥</button>
                </div>
            </div>
            <div class="field">
                <button class="btn secondary block" onclick="scanDevices()">æ‰«æå±€åŸŸç½‘è®¾å¤‡</button>
            </div>
            <div id="deviceList" class="log" style="height:140px;">ç‚¹å‡»æ‰«ææˆ–æ‰‹åŠ¨è¾“å…¥ IP</div>
            <div id="currentDevice" style="display:none; margin-top:10px; padding:10px; background:#1f2937; border:1px solid var(--border); border-radius:8px; font-size:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div><span style="color:var(--text-sub);">å½“å‰è®¾å¤‡:</span> <span id="currentDeviceIP" style="color:var(--primary); font-weight:600;"></span></div>
                    <button class="btn secondary" style="padding:4px 8px; font-size:11px;" onclick="disconnectDevice()">æ–­å¼€</button>
                </div>
            </div>

            <div class="section-title">2. å±å¹•æˆªå›¾</div>
            <div class="split">
                <button class="btn block" id="autoRefreshBtn" onclick="toggleAutoRefresh()">è·å–å±å¹•</button>
                <button class="btn secondary block" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="field">
                <label>æ—‹è½¬è§’åº¦</label>
                <select id="rotationSelect" style="width:100%; padding:8px; background:#1f2937; border:1px solid var(--border); color:var(--text); border-radius:6px;">
                    <option value="0">0Â°ï¼ˆåŸå§‹ï¼‰</option>
                    <option value="1">90Â°</option>
                    <option value="2" selected>180Â°</option>
                    <option value="3">270Â°</option>
                </select>
            </div>
            <div class="section-title">3. æ“ä½œå·¥å…·</div>
            <div class="toolbar">
                <div class="tool-btn active" id="tool-tap" onclick="setTool('tap')">ğŸ‘† ç‚¹å‡»</div>
                <div class="tool-btn" id="tool-double_tap" onclick="setTool('double_tap')">âœŒï¸ åŒå‡»</div>
                <div class="tool-btn" id="tool-long_press" onclick="setTool('long_press')">â³ é•¿æŒ‰</div>
                <div class="tool-btn" id="tool-swipe" onclick="setTool('swipe')">â†”ï¸ æ»‘åŠ¨</div>
            </div>
            <div class="section-title">4. æ–‡æœ¬æŒ‡ä»¤ (TTS)</div>
            <div class="field">
                <textarea id="ttsText" placeholder="è¯·è¾“å…¥æ’­æŠ¥å†…å®¹"></textarea>
            </div>
            <div class="split">
                <button class="btn block" onclick="sendTTS()">å‘é€æ’­æŠ¥</button>
                <button class="btn secondary block" onclick="stopTTS()">åœæ­¢æ’­æŠ¥</button>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šé¢„è§ˆåŒº -->
        <div class="panel" id="centerPanel">
            <div class="panel-header">
                <div class="panel-title">å±å¹•é¢„è§ˆ (å®æ—¶äº¤äº’)</div>
                <div class="small" id="coordDisplay">X: 0.00 Y: 0.00</div>
            </div>
            <div class="preview" id="screenContainer">
                <div class="placeholder" id="screenPlaceholder">ç­‰å¾…æˆªå›¾...</div>
                <img id="screenImg" src="" style="display:none" draggable="false">
                <div id="swipeOverlay" style="position:absolute; inset:0; pointer-events:none;"></div>
            </div>
            <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
                <button class="btn" style="flex:0 0 auto; padding:10px 20px;" onclick="executeArmHome()">ğŸ  æœºæ¢°è‡‚å½’ä½</button>
                <div style="flex:1; display:flex; gap:8px; align-items:center; padding:10px 12px; background:#1f2937; border:1px solid var(--border); border-radius:8px;">
                    <span style="color:var(--text-sub); font-size:12px;">æœºæ¢°è‡‚çŠ¶æ€:</span>
                    <span id="armStatus" style="color:var(--primary); font-weight:600; font-size:12px;">æœªçŸ¥</span>
                    <span style="margin-left:auto; color:var(--text-sub); font-size:11px;" id="armPosition">ä½ç½®: -</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ—¥å¿—åŒº -->
        <div class="panel" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">è¯†åˆ«ç»“æœ / æ—¥å¿—</div>
                <div class="badge" id="deviceBadge">æœªè¿æ¥</div>
            </div>
            <div class="log" id="logConsole"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let selectedDevice = '';
        let eventSource = null;
        let currentTool = 'tap';
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let longPressTimer = null;
        let longPressTriggered = false;
        let lastTapTime = 0;
        let lastTapX = 0;
        let lastTapY = 0;

        window.onload = function() {
            checkAPIStatus();
            connectLogStream();
            setupScreenInteraction();
            addLog('ç­‰å¾…æ“ä½œ...');
        };

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool-${tool}`).classList.add('active');
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸçš„é¼ æ ‡æ ·å¼
            const preview = document.getElementById('screenContainer');
            preview.className = 'preview tool-' + tool;
            
            addLog(`åˆ‡æ¢å·¥å…·: ${tool}`);
        }

        function addLog(msg, level='info') {
            const log = document.getElementById('logConsole');
            const line = document.createElement('div');
            line.className = 'log-line ' + (level === 'error' ? 'err' : level === 'warn' ? 'warn' : 'ok');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            line.innerHTML = `<span class="time">[${time}]</span>${msg}`;
            log.appendChild(line);
            log.scrollTop = log.scrollHeight;
        }

        function clearLogs() { document.getElementById('logConsole').innerHTML = ''; }

        async function checkAPIStatus() {
            const badge = document.getElementById('apiStatus');
            try {
                await fetch(`${API_BASE}/api/health`);
                badge.innerHTML = '<span class="status-dot ok"></span>API æ­£å¸¸';
            } catch {
                badge.innerHTML = '<span class="status-dot"></span>API ç¦»çº¿';
            }
        }

        function connectLogStream() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource(`${API_BASE}/api/telemetry/stream`);
            eventSource.onmessage = (ev) => {
                try {
                    const log = JSON.parse(ev.data);
                    addLog(log.message, log.level.toLowerCase());
                } catch {}
            };
        }

        async function scanDevices() {
            addLog('å¼€å§‹æ‰«æå±€åŸŸç½‘...');
            try {
                const res = await fetch(`${API_BASE}/api/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: 8888 })
                });
                const data = await res.json();
                if (data.success) {
                    renderDeviceList(data.devices);
                    addLog(`æ‰«æå®Œæˆï¼Œå‘ç° ${data.devices.length} ä¸ªè®¾å¤‡`);
                } else {
                    addLog('æ‰«æå¤±è´¥: ' + data.message, 'error');
                }
            } catch (e) {
                addLog('æ‰«æå¼‚å¸¸: ' + e.message, 'error');
            }
        }

        function renderDeviceList(devices) {
            const list = document.getElementById('deviceList');
            if (!devices.length) {
                list.innerHTML = 'æœªå‘ç°è®¾å¤‡';
                return;
            }
            list.innerHTML = '';
            devices.forEach(ip => {
                const div = document.createElement('div');
                div.className = 'log-line';
                div.style.cursor = 'pointer';
                div.textContent = ip;
                div.onclick = () => selectDevice(ip);
                list.appendChild(div);
            });
        }

        function selectDevice(ip) {
            selectedDevice = ip;
            const badge = document.getElementById('deviceBadge');
            badge.innerHTML = '<span class="status-dot ok"></span>' + ip;
            badge.classList.add('connected');
            
            // æ˜¾ç¤ºå½“å‰è®¾å¤‡ä¿¡æ¯
            document.getElementById('currentDevice').style.display = 'block';
            document.getElementById('currentDeviceIP').textContent = ip;
            
            // ç«‹å³æ£€æŸ¥è¿æ¥çŠ¶æ€
            checkDeviceConnection();
            
            addLog(`å·²è¿æ¥è®¾å¤‡: ${ip}`, 'ok');
        }

        function disconnectDevice() {
            if (!selectedDevice) return;
            
            const oldDevice = selectedDevice;
            selectedDevice = '';
            
            // é‡ç½® badge
            const badge = document.getElementById('deviceBadge');
            badge.innerHTML = 'æœªè¿æ¥';
            badge.classList.remove('connected');
            
            // éšè—å½“å‰è®¾å¤‡ä¿¡æ¯
            document.getElementById('currentDevice').style.display = 'none';
            
            // æ¸…é™¤æˆªå›¾
            const img = document.getElementById('screenImg');
            const placeholder = document.getElementById('screenPlaceholder');
            img.style.display = 'none';
            placeholder.style.display = 'flex';
            img.src = '';
            
            addLog(`å·²æ–­å¼€è®¾å¤‡: ${oldDevice}`, 'warn');
        }

        function connectManual() {
            const ip = document.getElementById('manualIP').value.trim();
            if (!ip) return;
            selectDevice(ip);
        }

        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        async function refreshScreenshot(silent = false) {
            if (!selectedDevice) return addLog('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warn');
            const img = document.getElementById('screenImg');
            const placeholder = document.getElementById('screenPlaceholder');
            try {
                const startTime = Date.now();
                const rotationValue = document.getElementById('rotationSelect').value;
                const requestBody = { 
                    device_ip: selectedDevice,
                    rotation: parseInt(rotationValue)
                };
                
                // æ‰“å°è¯·æ±‚ä¿¡æ¯
                console.log('[æˆªå›¾è¯·æ±‚]', requestBody);
                addLog(`ğŸ“¤ å‘é€æˆªå›¾è¯·æ±‚: è®¾å¤‡=${selectedDevice}, æ—‹è½¬=${rotationValue}`);
                
                const res = await fetch(`${API_BASE}/api/s3/screenshot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                // æ‰“å°å“åº”çŠ¶æ€
                console.log('[æˆªå›¾å“åº”] çŠ¶æ€ç :', res.status, res.statusText);
                addLog(`ğŸ“¥ æ”¶åˆ°å“åº”: HTTP ${res.status}`);
                
                const data = await res.json();
                const duration = Date.now() - startTime;
                
                // æ‰“å°å“åº”æ•°æ®
                console.log('[æˆªå›¾æ•°æ®]', data);
                addLog(`ğŸ“Š å“åº”æ•°æ®: ${JSON.stringify(data)}`);
                
                if (data.success && data.path) {
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                    const timestamp = Date.now();
                    const imgUrl = `${API_BASE}/${data.path}?t=${timestamp}`;
                    
                    console.log('[å›¾ç‰‡åŠ è½½] URL:', imgUrl);
                    addLog(`ğŸ–¼ï¸ å¼€å§‹åŠ è½½å›¾ç‰‡: ${imgUrl}`);
                    
                    // åˆ›å»ºæ–°çš„å›¾ç‰‡å¯¹è±¡æ¥é¢„åŠ è½½
                    const newImg = new Image();
                    newImg.onload = function() {
                        console.log('[å›¾ç‰‡åŠ è½½] æˆåŠŸ', {
                            naturalWidth: newImg.naturalWidth,
                            naturalHeight: newImg.naturalHeight
                        });
                        // ç¡®ä¿å®¹å™¨å¯ç”¨äº‹ä»¶
                        const container = document.getElementById('screenContainer');
                        container.style.pointerEvents = 'auto';
                        
                        // æ›´æ–°ä¸»å›¾åƒ
                        img.src = imgUrl;
                        img.style.display = 'block';
                        img.style.pointerEvents = 'none';
                        placeholder.style.display = 'none';
                        
                        addLog(`âœ“ å›¾ç‰‡å·²åŠ è½½ (${newImg.naturalWidth}Ã—${newImg.naturalHeight}px)`, 'ok');
                    };
                    newImg.onerror = function() {
                        console.error('[å›¾ç‰‡åŠ è½½] å¤±è´¥');
                        addLog('âœ— å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                        // ç¡®ä¿å®¹å™¨ä»ç„¶å¯äº¤äº’
                        const container = document.getElementById('screenContainer');
                        container.style.pointerEvents = 'auto';
                    };
                    
                    newImg.src = imgUrl;
                    
                    if (!silent) {
                        addLog(`âœ“ æˆªå›¾æˆåŠŸ (è€—æ—¶${duration}ms, æ—‹è½¬${rotationValue}Ã—90Â°)`, 'ok');
                    }
                } else {
                    console.error('[æˆªå›¾å¤±è´¥]', data);
                    addLog(`âœ— æˆªå›¾å¤±è´¥: ${data.error || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('[æˆªå›¾å¼‚å¸¸]', e);
                addLog('âœ— æˆªå›¾é”™è¯¯: ' + e.message, 'error');
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshing) {
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                console.log('Stopping auto refresh, interval:', autoRefreshInterval);
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                isAutoRefreshing = false;
                btn.textContent = 'è·å–å±å¹•';
                btn.classList.remove('btn-success');
                addLog('âœ“ å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°', 'ok');
            } else {
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                if (!selectedDevice) {
                    addLog('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warn');
                    return;
                }
                
                isAutoRefreshing = true;
                btn.textContent = 'â¸ åœæ­¢åˆ·æ–°';
                btn.classList.add('btn-success');
                addLog('âœ“ å·²å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯2ç§’ï¼‰', 'ok');
                
                // ç«‹å³æˆªå›¾ä¸€æ¬¡
                refreshScreenshot(false); // æ˜¾ç¤ºæ—¥å¿—
                
                // æ¯2ç§’åˆ·æ–°ï¼Œé™é»˜æ¨¡å¼é¿å…åˆ·å±
                autoRefreshInterval = setInterval(() => {
                    refreshScreenshot(true); // é™é»˜æ¨¡å¼
                }, 2000);
                console.log('Started auto refresh, interval:', autoRefreshInterval);
            }
        }

        function setupScreenInteraction() {
            const container = document.getElementById('screenContainer');
            const img = document.getElementById('screenImg');

            // é¼ æ ‡ç§»åŠ¨ - æ˜¾ç¤ºåæ ‡
            container.addEventListener('mousemove', (e) => {
                if (!img.complete || !img.src) return;
                const rect = img.getBoundingClientRect();
                // åŸå§‹åæ ‡ï¼ˆå±å¹•åæ ‡ç³»ï¼‰
                const screenX = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const screenY = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
                
                // ç”±äºå›¾ç‰‡é€†æ—¶é’ˆæ—‹è½¬äº†90åº¦ï¼Œéœ€è¦è½¬æ¢åæ ‡
                // æ—‹è½¬å: æ–°X = åŸY, æ–°Y = 1 - åŸX
                const x = screenY;
                const y = 1 - screenX;
                
                document.getElementById('coordDisplay').textContent = `X: ${x.toFixed(2)} Y: ${y.toFixed(2)}`;
                
                // æ»‘åŠ¨æ¨¡å¼ä¸‹ç»˜åˆ¶çº¿æ¡
                if (isDragging && currentTool === 'swipe') {
                    drawSwipeLine(x, y);
                }
            });

            // é¼ æ ‡æŒ‰ä¸‹
            container.addEventListener('mousedown', (e) => {
                if (!selectedDevice || !img.complete || !img.src) return;
                e.preventDefault();
                
                const rect = img.getBoundingClientRect();
                // åŸå§‹å±å¹•åæ ‡
                const screenX = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const screenY = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
                
                // åæ ‡è½¬æ¢ï¼ˆé€†æ—¶é’ˆæ—‹è½¬90åº¦ï¼‰
                startX = screenY;
                startY = 1 - screenX;
                
                isDragging = true;
                longPressTriggered = false;
                
                // æ˜¾ç¤ºæŒ‰ä¸‹åé¦ˆ
                showClickFeedback(e.clientX, e.clientY);
                
                // é•¿æŒ‰æ£€æµ‹
                if (currentTool === 'long_press') {
                    longPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        addLog(`é•¿æŒ‰: (${startX.toFixed(2)}, ${startY.toFixed(2)})`, 'ok');
                        executeLongPress(startX, startY);
                    }, 500); // 500ms è§¦å‘é•¿æŒ‰
                }
            });

            // é¼ æ ‡æŠ¬èµ·
            container.addEventListener('mouseup', (e) => {
                if (!selectedDevice || !isDragging) return;
                e.preventDefault();
                
                // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                if (longPressTimer) {
                // åŸå§‹å±å¹•åæ ‡
                const screenX = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const screenY = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
                
                // åæ ‡è½¬æ¢ï¼ˆé€†æ—¶é’ˆæ—‹è½¬90åº¦ï¼‰
                const endX = screenY;
                const endY = 1 - screenX
                }
                
                isDragging = false;
                const rect = img.getBoundingClientRect();
                const endX = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const endY = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
                
                clearSwipeLine();
                
                // å¦‚æœå·²è§¦å‘é•¿æŒ‰ï¼Œä¸æ‰§è¡Œå…¶ä»–æ“ä½œ
                if (longPressTriggered) {
                    return;
                }
                
                // æ»‘åŠ¨æ¨¡å¼
                if (currentTool === 'swipe') {
                    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    if (distance > 0.02) { // æœ€å°æ»‘åŠ¨è·ç¦»
                        executeSwipe(startX, startY, endX, endY);
                    } else {
                        addLog('æ»‘åŠ¨è·ç¦»å¤ªçŸ­ï¼Œå·²å¿½ç•¥', 'warn');
                    }
                    return;
                }
                
                // åŒå‡»æ£€æµ‹
                if (currentTool === 'double_tap') {
                    const now = Date.now();
                    const timeDiff = now - lastTapTime;
                    const distDiff = Math.sqrt(Math.pow(endX - lastTapX, 2) + Math.pow(endY - lastTapY, 2));
                    
                    if (timeDiff < 500 && distDiff < 0.05) {
                        // åŒå‡»è§¦å‘
                        executeDoubleTap(endX, endY);
                        lastTapTime = 0; // é‡ç½®
                    } else {
                        // è®°å½•ç¬¬ä¸€æ¬¡ç‚¹å‡»
                        lastTapTime = now;
                        lastTapX = endX;
                        lastTapY = endY;
                        addLog('ç­‰å¾…ç¬¬äºŒæ¬¡ç‚¹å‡»...', 'warn');
                    }
                    return;
                }
                
                // æ™®é€šç‚¹å‡»
                if (currentTool === 'tap') {
                    executeTap(endX, endY);
                }
            });

            // é¼ æ ‡ç¦»å¼€ - æ¸…ç†çŠ¶æ€
            container.addEventListener('mouseleave', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                isDragging = false;
                clearSwipeLine();
            });
        }

        function drawSwipeLine(x2, y2) {
            const overlay = document.getElementById('swipeOverlay');
            overlay.innerHTML = '';
            const rect = document.getElementById('screenImg').getBoundingClientRect();
            
            // èµ·ç‚¹åœ†åœˆ
            const startDot = document.createElement('div');
            startDot.style.position = 'absolute';
            startDot.style.width = '12px';
            startDot.style.height = '12px';
            startDot.style.borderRadius = '50%';
            startDot.style.background = '#22d3ee';
            startDot.style.left = `${startX * rect.width - 6}px`;
            startDot.style.top = `${startY * rect.height - 6}px`;
            overlay.appendChild(startDot);
            
            // è¿æ¥çº¿
            const line = document.createElement('div');
            line.style.position = 'absolute';
            line.style.height = '3px';
            line.style.background = 'linear-gradient(90deg, #22d3ee, #06b6d4)';
            line.style.boxShadow = '0 0 10px rgba(34, 211, 238, 0.5)';
            
            const x1 = startX * rect.width, y1 = startY * rect.height;
            const px2 = x2 * rect.width, py2 = y2 * rect.height;
            const length = Math.hypot(px2 - x1, py2 - y1);
            const angle = Math.atan2(py2 - y1, px2 - x1) * 180 / Math.PI;
            
            line.style.width = `${length}px`;
            line.style.left = `${x1}px`;
            line.style.top = `${y1}px`;
            line.style.transformOrigin = '0 50%';
            line.style.transform = `rotate(${angle}deg)`;
            overlay.appendChild(line);
            
            // ç»ˆç‚¹ç®­å¤´
            const endArrow = document.createElement('div');
            endArrow.style.position = 'absolute';
            endArrow.style.width = '0';
            endArrow.style.height = '0';
            endArrow.style.borderLeft = '8px solid #22d3ee';
            endArrow.style.borderTop = '5px solid transparent';
            endArrow.style.borderBottom = '5px solid transparent';
            endArrow.style.left = `${px2}px`;
            endArrow.style.top = `${py2 - 5}px`;
            endArrow.style.transformOrigin = '0 50%';
            endArrow.style.transform = `rotate(${angle}deg)`;
            overlay.appendChild(endArrow);
        }

        function clearSwipeLine() {
            document.getElementById('swipeOverlay').innerHTML = '';
        }

        function showClickFeedback(clientX, clientY) {
            const feedback = document.createElement('div');
            feedback.style.position = 'fixed';
            feedback.style.left = `${clientX}px`;
            feedback.style.top = `${clientY}px`;
            feedback.style.width = '40px';
            feedback.style.height = '40px';
            feedback.style.marginLeft = '-20px';
            feedback.style.marginTop = '-20px';
            feedback.style.borderRadius = '50%';
            feedback.style.border = '3px solid #22d3ee';
            feedback.style.pointerEvents = 'none';
            feedback.style.animation = 'ripple 0.6s ease-out';
            feedback.style.zIndex = '9999';
            
            document.body.appendChild(feedback);
            setTimeout(() => feedback.remove(), 600);
        }

        async function executeTap(x, y) {
            const requestData = { device_ip: selectedDevice, x, y, count: 1 };
            console.log('[ç‚¹å‡»è¯·æ±‚]', requestData);
            addLog(`ğŸ“¤ ç‚¹å‡»: (${x.toFixed(3)}, ${y.toFixed(3)})`);
            try {
                const startTime = Date.now();
                const res = await fetch(`${API_BASE}/api/s3/tap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                console.log('[ç‚¹å‡»å“åº”] çŠ¶æ€ç :', res.status, res.statusText);
                
                const data = await res.json();
                const duration = Date.now() - startTime;
                
                console.log('[ç‚¹å‡»ç»“æœ]', data, `è€—æ—¶: ${duration}ms`);
                
                if (data.success) {
                    addLog(`âœ“ ç‚¹å‡»æˆåŠŸ (${duration}ms) - ${data.message || ''}`, 'ok');
                } else {
                    addLog(`âœ— ç‚¹å‡»å¤±è´¥ (${duration}ms): ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('[ç‚¹å‡»å¼‚å¸¸]', e);
                addLog('âœ— ç‚¹å‡»å¼‚å¸¸: ' + e.message, 'error');
            }
        }

        async function executeDoubleTap(x, y) {
            const requestData = { device_ip: selectedDevice, x, y, count: 2 };
            console.log('[åŒå‡»è¯·æ±‚]', requestData);
            addLog(`ğŸ“¤ åŒå‡»: (${x.toFixed(3)}, ${y.toFixed(3)})`);
            try {
                const startTime = Date.now();
                const res = await fetch(`${API_BASE}/api/s3/tap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                console.log('[åŒå‡»å“åº”] çŠ¶æ€ç :', res.status);
                
                const data = await res.json();
                const duration = Date.now() - startTime;
                
                console.log('[åŒå‡»ç»“æœ]', data, `è€—æ—¶: ${duration}ms`);
                
                if (data.success) {
                    addLog(`âœ“ åŒå‡»æˆåŠŸ (${duration}ms)`, 'ok');
                } else {
                    addLog(`âœ— åŒå‡»å¤±è´¥ (${duration}ms): ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('[åŒå‡»å¼‚å¸¸]', e);
                addLog('âœ— åŒå‡»å¼‚å¸¸: ' + e.message, 'error');
            }
        }

        async function executeLongPress(x, y, duration = 1000) {
            const requestData = { device_ip: selectedDevice, x, y, duration };
            console.log('[é•¿æŒ‰è¯·æ±‚]', requestData);
            addLog(`ğŸ“¤ é•¿æŒ‰: (${x.toFixed(3)}, ${y.toFixed(3)}) ${duration}ms`);
            try {
                const startTime = Date.now();
                const res = await fetch(`${API_BASE}/api/s3/long_press`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                console.log('[é•¿æŒ‰å“åº”] çŠ¶æ€ç :', res.status);
                
                const data = await res.json();
                const elapsed = Date.now() - startTime;
                
                console.log('[é•¿æŒ‰ç»“æœ]', data, `è€—æ—¶: ${elapsed}ms`);
                
                if (data.success) {
                    addLog(`âœ“ é•¿æŒ‰æˆåŠŸ (${elapsed}ms)`, 'ok');
                } else {
                    addLog(`âœ— é•¿æŒ‰å¤±è´¥ (${elapsed}ms): ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('[é•¿æŒ‰å¼‚å¸¸]', e);
                addLog('âœ— é•¿æŒ‰å¼‚å¸¸: ' + e.message, 'error');
            }
        }

        async function executeSwipe(sx, sy, ex, ey) {
            const distance = Math.sqrt(Math.pow(ex - sx, 2) + Math.pow(ey - sy, 2));
            const requestData = { 
                device_ip: selectedDevice, 
                start_x: sx, 
                start_y: sy, 
                end_x: ex, 
                end_y: ey 
            };
            console.log('[æ»‘åŠ¨è¯·æ±‚]', requestData, `è·ç¦»: ${distance.toFixed(3)}`);
            addLog(`ğŸ“¤ æ»‘åŠ¨: (${sx.toFixed(3)},${sy.toFixed(3)}) â†’ (${ex.toFixed(3)},${ey.toFixed(3)}) è·ç¦»:${distance.toFixed(3)}`);
            try {
                const startTime = Date.now();
                const res = await fetch(`${API_BASE}/api/s3/swipe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                console.log('[æ»‘åŠ¨å“åº”] çŠ¶æ€ç :', res.status);
                
                const data = await res.json();
                const duration = Date.now() - startTime;
                
                console.log('[æ»‘åŠ¨ç»“æœ]', data, `è€—æ—¶: ${duration}ms`);
                
                if (data.success) {
                    addLog(`âœ“ æ»‘åŠ¨æˆåŠŸ (${duration}ms)`, 'ok');
                } else {
                    addLog(`âœ— æ»‘åŠ¨å¤±è´¥ (${duration}ms): ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('[æ»‘åŠ¨å¼‚å¸¸]', e);
                addLog('âœ— æ»‘åŠ¨å¼‚å¸¸: ' + e.message, 'error');
            }
        }

        async function executeArmHome() {
            if (!selectedDevice) return addLog('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warn');
            
            addLog('â†’ æœºæ¢°è‡‚å½’ä½ä¸­...', 'ok');
            updateArmStatus('å½’ä½ä¸­...', '-');
            
            try {
                const startTime = Date.now();
                // ç§»åŠ¨åˆ°åŸç‚¹ (0, 0)
                const res = await fetch(`${API_BASE}/api/s3/tap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_ip: selectedDevice, x: 0, y: 0, count: 0 })
                });
                const data = await res.json();
                const duration = Date.now() - startTime;
                
                if (data.success) {
                    addLog(`âœ“ æœºæ¢°è‡‚å½’ä½æˆåŠŸ (${duration}ms)`, 'ok');
                    updateArmStatus('å·²å½’ä½', '(0, 0)');
                } else {
                    addLog(`âœ— å½’ä½å¤±è´¥ (${duration}ms): ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    updateArmStatus('å½’ä½å¤±è´¥', '-');
                }
            } catch (e) {
                addLog('âœ— å½’ä½å¼‚å¸¸: ' + e.message, 'error');
                updateArmStatus('å¼‚å¸¸', '-');
            }
        }

        function updateArmStatus(status, position) {
            document.getElementById('armStatus').textContent = status;
            document.getElementById('armPosition').textContent = `ä½ç½®: ${position}`;
        }

        // æ£€æŸ¥è®¾å¤‡è¿æ¥çŠ¶æ€
        let connectionCheckFailures = 0;
        const MAX_FAILURES = 2; // è¿ç»­2æ¬¡å¤±è´¥æ‰åˆ¤å®šä¸ºç¦»çº¿

        async function checkDeviceConnection() {
            if (!selectedDevice) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/s3/status?device_ip=${selectedDevice}`, {
                    timeout: 5000
                });
                const data = await res.json();
                
                if (data.success && data.data) {
                    // è¿æ¥æ­£å¸¸ï¼Œé‡ç½®å¤±è´¥è®¡æ•°
                    connectionCheckFailures = 0;
                    
                    // æ›´æ–°badgeä¸ºåœ¨çº¿çŠ¶æ€
                    const badge = document.getElementById('deviceBadge');
                    badge.innerHTML = '<span class="status-dot ok"></span>' + selectedDevice;
                    badge.classList.add('connected');
                    badge.classList.remove('error');
                    
                    // æ›´æ–°æœºæ¢°è‡‚çŠ¶æ€
                    const status = data.data;
                    const armConnected = status.serial_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                    const armInfo = status.serial_status || 'ç©ºé—²';
                    updateArmStatus(armConnected, armInfo);
                } else {
                    handleConnectionFailure();
                }
            } catch (e) {
                handleConnectionFailure();
            }
        }

        function handleConnectionFailure() {
            connectionCheckFailures++;
            
            if (connectionCheckFailures >= MAX_FAILURES) {
                // è®¾å¤‡ç¦»çº¿
                const badge = document.getElementById('deviceBadge');
                badge.innerHTML = '<span class="status-dot error"></span>' + selectedDevice + ' (ç¦»çº¿)';
                badge.classList.remove('connected');
                badge.classList.add('error');
                
                updateArmStatus('è®¾å¤‡ç¦»çº¿', '-');
                
                if (connectionCheckFailures === MAX_FAILURES) {
                    addLog(`âš ï¸ è®¾å¤‡ ${selectedDevice} å·²ç¦»çº¿`, 'error');
                }
            }
        }

        // å®šæœŸæ£€æŸ¥è®¾å¤‡è¿æ¥å’Œæ›´æ–°æœºæ¢°è‡‚çŠ¶æ€
        setInterval(() => {
            if (selectedDevice) {
                checkDeviceConnection();
            }
        }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡

        async function executeCommand(cmd) {
            if (!selectedDevice) return addLog('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warn');
            
            addLog(`æ‰§è¡Œå‘½ä»¤: ${cmd}`);
            
            try {
                let endpoint = '';
                let body = { device_ip: selectedDevice };
                
                switch(cmd) {
                    case 'home':
                        // Home åŠŸèƒ½ï¼šå¯ä»¥é€šè¿‡ç‰¹å®šæ¥å£æˆ–æ‰‹åŠ¿å®ç°
                        endpoint = '/api/s3/swipe';
                        Object.assign(body, { 
                            start_x: 0.5, start_y: 0.95, 
                            end_x: 0.5, end_y: 0.5 
                        });
                        break;
                    case 'back':
                        // Back åŠŸèƒ½ï¼šä»å·¦è¾¹ç¼˜æ»‘åŠ¨
                        endpoint = '/api/s3/swipe';
                        Object.assign(body, { 
                            start_x: 0.05, start_y: 0.5, 
                            end_x: 0.5, end_y: 0.5 
                        });
                        break;
                    case 'swipe_up':
                        endpoint = '/api/s3/swipe';
                        Object.assign(body, { 
                            start_x: 0.5, start_y: 0.8, 
                            end_x: 0.5, end_y: 0.2 
                        });
                        break;
                    case 'swipe_down':
                        endpoint = '/api/s3/swipe';
                        Object.assign(body, { 
                            start_x: 0.5, start_y: 0.2, 
                            end_x: 0.5, end_y: 0.8 
                        });
                        break;
                    case 'swipe_left':
                        endpoint = '/api/s3/swipe';
                        Object.assign(body, { 
                            start_x: 0.8, start_y: 0.5, 
                            end_x: 0.2, end_y: 0.5 
                        });
                        break;
                    case 'swipe_right':
                        endpoint = '/api/s3/swipe';
                        Object.assign(body, { 
                            start_x: 0.2, start_y: 0.5, 
                            end_x: 0.8, end_y: 0.5 
                        });
                        break;
                    default:
                        addLog('æœªçŸ¥å‘½ä»¤: ' + cmd, 'error');
                        return;
                }
                
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                if (data.success) {
                    addLog(`å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: ${cmd}`);
                } else {
                    addLog('å‘½ä»¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                addLog('å‘½ä»¤é”™è¯¯: ' + e.message, 'error');
            }
        }

        async function sendTTS() {
            if (!selectedDevice) return addLog('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'warn');
            
            const text = document.getElementById('ttsText').value.trim();
            if (!text) return addLog('è¯·è¾“å…¥æ’­æŠ¥å†…å®¹', 'warn');
            
            addLog(`å‘é€TTS: ${text}`);
            
            try {
                const res = await fetch(`${API_BASE}/api/s3/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_ip: selectedDevice, text })
                });
                
                const data = await res.json();
                if (data.success) {
                    addLog('TTS æ’­æŠ¥æˆåŠŸ');
                    document.getElementById('ttsText').value = '';
                } else {
                    addLog('TTS å¤±è´¥: ' + (data.message || 'TTS åŠŸèƒ½æœªå®ç°'), 'warn');
                }
            } catch (e) {
                addLog('TTS é”™è¯¯: ' + e.message, 'error');
            }
        }
        
        function stopTTS() {
            addLog('åœæ­¢æ’­æŠ¥åŠŸèƒ½å¾…å®ç°', 'warn');
        }
    </script>
</body>
</html>
